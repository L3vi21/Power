<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equipment Monitoring Dashboard</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        body {
            background-color: #1a202c;
            color: #e2e8f0;
        }
    </style>
</head>
<body class="font-sans">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-3x1 sm:text-4x1 font-bold text-white tracking-tight">Equipment Monitoring Dashboard</h1>
            <p class="text-gray-400 mt-1">Powered by Flask and Chart.js</p>
        </header>
        <!--Main Grid-->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!--Controls Panel-->
            <aside class="lg:col-span-1 bg-gray-800 p-6 rounded-x1 shadow-lg h-fit">
                <h2 class="text-xl font-semibold mb-6 border-b border-gray-700 pb-3 text-white">Filters</h2>
                <div class="space-y-6">
                    <!--Equipment Selector-->
                    <div>
                        <label for="equipment-filter" class="block text-sm font-medium text-gray-300 mb-2">Equipment</label>
                        <select id="equipment-filter" class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <!--Options will be populated by JavaScript-->
                        </select> 
                    </div>
                    <!--Register Selector-->
                    <div>
                        <label for="register-filter" class="block text-sm font-medium text-gray-300 mb-2">Data / Register</label>
                        <select id="register-filter" class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <!--Options will be populated by JavaScript-->
                        </select>
                    </div>
                    <!--Date Range-->
                    <div>
                        <label  class="block text-sm font-medium text-gray-300 mb-2">Date Range</label>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <input type="date" id="start-date" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <input type="date" id="end-date" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                </div>
            </aside>

            <!--Main Container-->
            <main class="lg:col-span-3 space-y-6">
                <!--Chart Container-->
                <div class="bg-gray-800 p-4 sm:p-6 rounded-x1 shadow-lg">
                    <div id="loading-indicator" class="text-center p-8">Loading Chart...</div>
                    <canvas id="data_chart" style="display: none;"></canvas>
                </div>

                <!--Data Table Container-->
                <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold text-white mb-4">Raw Data</h3>
                    <div id="table-container" class="max-h-96 overflow-y-auto">
                        <table class="w-full text-sm text-left text-gray-300">
                            <thead class="text-xs text-gray-400 uppercase bg-gray-700 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-4 py-3">Timestamp</th>
                                    <th scope="col" class="px-4 py-3">Equipment</th>
                                    <th scope="col" class="px-4 py-3">Register Name</th>
                                    <th scope="col" class="px-4 py-3">Value</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body">
                                <!--Populated by JS-->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script>
        // Global variable to hold the chart instance so we can update it
        let data_chart;

        // This function runs when the page loads to fill the dropdowns
        async function populateFilters() {
            try {
                const response = await fetch('/api/filters');
                const data = await response.json();

                const equipmentSelect = document.getElementById('equipment-filter');
                equipmentSelect.innerHTML = '<option>All Equipment</option>';
                data.equipments.forEach(eq => {
                    equipmentSelect.innerHTML += `<option>${eq}</option>`;
                });

                const registerSelect = document.getElementById('register-filter');
                registerSelect.innerHTML = '<option>All Registers</option>';
                data.registers.forEach(reg => {
                    registerSelect.innerHTML += `<option>${reg}</option>`;
                });
            } catch (error) {
                console.error("Error populating filters:", error);
            }
        }

        // This function runs when you click the "Update" button
        async function updateDashboard() {
            const equipment = document.getElementById('equipment-filter').value;
            const register = document.getElementById('register-filter').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            // --- Helper function to clear the display ---
            function clearDisplay() {
                if (myChart) {
                    myChart.destroy(); // Clear the chart
                }
                const tableBody = document.querySelector("#data-table tbody");
                tableBody.innerHTML = '<tr><td colspan="4">Please select specific equipment and a register to display data.</td></tr>'; // Clear the table and show a message
            }

            // NEW: Check if the user has made a specific selection.
            if (equipment === 'All Equipment' || register === 'All Registers') {
                clearDisplay();
                return; // Stop here if no specific selection is made.
            }

            // Build the URL to call the API
            const url = new URL('/api/data', window.location.origin);
            url.searchParams.append('equipment', equipment);
            url.searchParams.append('register', register);
            if (startDate) url.searchParams.append('startDate', startDate);
            if (endDate) url.searchParams.append('endDate', endDate);

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();

                // If the API returns no data for the selection, clear the display
                if (data.length === 0) {
                    clearDisplay();
                    return;
                }

                // --- Update the Chart ---
                const labels = data.map(item => item.Timestamp);
                const values = data.map(item => item.Value);

                const ctx = document.getElementById('myChart').getContext('2d');
                if (myChart) {
                    myChart.destroy();
                }
                myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                    labels: labels,
                        datasets: [{
                            label: `Value for ${register}`,
                            data: values,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

        // --- Update the Table ---
        const tableBody = document.querySelector("#data-table tbody");
        tableBody.innerHTML = '';
        data.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row.Timestamp}</td>
                <td>${row.Description}</td>
                <td>${row.Register_Name}</td>
                <td>${row.Value.toFixed(2)}</td>
            `;
            tableBody.appendChild(tr);
        });

    } catch (error) {
        console.error("Could not fetch or display data:", error);
        alert("Error: Unable to display data. Check the console for details.");
    }
}


        // This runs once after the page has fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            populateFilters();

            // Set default dates to the last 7 days
            const today = new Date();
            const pastDate = new Date();
            pastDate.setDate(today.getDate() - 7);
            document.getElementById('end-date').value = today.toISOString().split('T')[0];
            document.getElementById('start-date').value = pastDate.toISOString().split('T')[0];

            updateDashboard(); // Load the initial view

            // Add event listener to your button
            document.getElementById('update-button').addEventListener('click', updateDashboard);
        });
    </script>

</body>
</html>


