<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Substation Data Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        h1 {
            color: #2c3e50;
        }
        .controls {
            text-align: center;
            margin-bottom: 30px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .controls label {
            margin: 0 15px;
            font-size: 16px;
            cursor: pointer;
        }
        .controls input[type="checkbox"] {
            margin-right: 5px;
        }
        .chart-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            padding: 10px;
        }
        .chart-wrapper {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        /* Initially hide the chart wrappers */
        .chart-wrapper.hidden {
            display: none;
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>Substation Data Graphs</h1>
        <p>Use the checkboxes to show or hide the graphs.</p>
    </div>

    <div class="controls">
        <label>
            <input type="checkbox" id="toggleChart1" onchange="toggleChart('chart1Wrapper', 'myChart1', 'chart1Data', this.checked)">
            Show Power Factor Graph
        </label>
        <label>
            <input type="checkbox" id="toggleChart2" onchange="toggleChart('chart2Wrapper', 'myChart2', 'chart2Data', this.checked)">
            Show Voltage Graph
        </label>
        </div>

    <div class="chart-container">
        <div id="chart1Wrapper" class="chart-wrapper hidden">
            <canvas id="myChart1"></canvas>
        </div>
        <div id="chart2Wrapper" class="chart-wrapper hidden">
            <canvas id="myChart2"></canvas>
        </div>
        </div>

    <script>
        // This line injects the data from your Flask backend into JavaScript.
        // Your Flask route should pass a dictionary of data like:
        // graph_data = {
        //   "chart1Data": {"labels": [...], "values": [...]},
        //   "chart2Data": {"labels": [...], "values": [...]},
        // }
        // The |tojson filter is crucial for safely converting the data.
        const allGraphData = {{ graph_data|tojson }};

        // This object will hold the active Chart.js instances
        const activeCharts = {};

        function createChart(canvasId, data, label, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // If a chart already exists on this canvas, destroy it first
            if (activeCharts[canvasId]) {
                activeCharts[canvasId].destroy();
            }

            // Create the new chart
            activeCharts[canvasId] = new Chart(ctx, {
                type: 'line', // You can change this to 'bar', 'pie', etc.
                data: {
                    labels: data.labels, // X-axis labels (e.g., timestamps)
                    datasets: [{
                        label: label, // Legend label
                        data: data.values, // Y-axis data points
                        borderColor: color,
                        backgroundColor: color + '33', // Lighter version for area fill
                        fill: true,
                        tension: 0.1 // Makes the line slightly curved
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        function toggleChart(wrapperId, canvasId, dataKey, isVisible) {
            const wrapper = document.getElementById(wrapperId);

            if (isVisible) {
                // Show the container and create the chart
                wrapper.classList.remove('hidden');
                const chartData = allGraphData[dataKey];
                
                // Customize label and color based on dataKey
                let label = 'Data';
                let color = '#3498db'; // Default color
                if (dataKey === 'chart1Data') {
                    label = 'Power Factor';
                    color = '#2ecc71';
                } else if (dataKey === 'chart2Data') {
                    label = 'Average Voltage';
                    color = '#e74c3c';
                }

                if (chartData) {
                    createChart(canvasId, chartData, label, color);
                } else {
                    console.error('No data found for key:', dataKey);
                }
            } else {
                // Hide the container and destroy the chart to free up memory
                wrapper.classList.add('hidden');
                if (activeCharts[canvasId]) {
                    activeCharts[canvasId].destroy();
                    delete activeCharts[canvasId]; // Remove from active charts object
                }
            }
        }
    </script>

</body>
</html>